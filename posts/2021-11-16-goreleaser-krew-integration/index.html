<!doctype html><html>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge"><title>Publishing Krew plugin manifests with GoReleaser - tohjustin's blog</title><link rel=icon type=image/png href=icons/favicon.png><meta name=viewport content="width=device-width,initial-scale=1">
<meta property="og:title" content="Publishing Krew plugin manifests with GoReleaser">
<meta property="og:description" content="GoReleaser v1.0.0 introduced a Krew integration to generate and publish Krew Plugin Manifests. This is a walkthrough of using GoReleaser to publish kubectl plugins to a custom custom plugin index.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://tohjustin.github.io/posts/2021-11-16-goreleaser-krew-integration/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-11-16T17:30:00+08:00">
<meta property="article:modified_time" content="2021-11-16T17:30:00+08:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Publishing Krew plugin manifests with GoReleaser">
<meta name=twitter:description content="GoReleaser v1.0.0 introduced a Krew integration to generate and publish Krew Plugin Manifests. This is a walkthrough of using GoReleaser to publish kubectl plugins to a custom custom plugin index.">
<link rel=preconnect href=https://fonts.googleapis.com>
<link rel=preconnect href=https://fonts.gstatic.com crossorigin>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono&family=Raleway:wght@200;600&family=Ubuntu:wght@400;700&display=swap" rel=stylesheet>
<link rel=stylesheet type=text/css media=screen href=https://tohjustin.github.io/css/normalize.css>
<link rel=stylesheet type=text/css media=screen href=https://tohjustin.github.io/css/main.css><link rel=stylesheet type=text/css href=https://tohjustin.github.io/css/dark.css>
<script src=https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js></script>
<script src=https://tohjustin.github.io/js/main.js></script>
<script defer data-domain=tohjustin.github.io src=https://plausible.io/js/plausible.js></script>
</head>
<body>
<div class="container wrapper post">
<div class=header>
<base href=https://tohjustin.github.io/>
<h1 class=site-title><a href=https://tohjustin.github.io/>tohjustin's blog</a></h1>
<div class=site-description><h2>YAML Engineer. Previously pushing packets & pixels.</h2><nav class="nav social">
<ul class=flat><a href=https://github.com/tohjustin title=Github><i data-feather=github></i></a><a href=https://twitter.com/tohjustin_ title=Twitter><i data-feather=twitter></i></a><a href=/index.xml title=RSS><i data-feather=rss></i></a></ul>
</nav>
</div>
<nav class=nav>
<ul class=flat>
<li>
<a href=/>Home</a>
</li>
<li>
<a href=/posts>All posts</a>
</li>
<li>
<a href=/tags>Tags</a>
</li>
</ul>
</nav>
</div>
<div class=post-header>
<h1 class=title>Publishing Krew plugin manifests with GoReleaser</h1>
<div class=meta>Posted at &mdash; Nov 16, 2021</div>
</div>
<div class=markdown>
<p><a href=https://carlosbecker.com/posts/goreleaser-v1/>GoReleaser v1.0.0</a> was just released this week & I wanted to try out their new <a href=https://goreleaser.com/customization/krew/>Krew integration</a> feature to see if I can use it in my GitHub Actions workflow to publish new releases of my kubectl plugins to the official <a href=https://github.com/kubernetes-sigs/krew-index>krew index</a>.</p>
<p>Unfortunately it only works with <a href=https://krew.sigs.k8s.io/docs/user-guide/custom-indexes>custom plugin indexes</a>, so I will still have to stick with the <a href=https://github.com/rajatjindal/krew-release-bot>rajatjindal/krew-release-bot</a> GitHub action. ðŸ˜­ However I always wanted to try hosting a custom plugin index, so this finally gave me enough incentive to commit into doing it & share the process.</p>
<h2 id=hosting-a-custom-plugin-index>Hosting a custom plugin index</h2>
<p>A custom plugin index is essentially a Git repository that follows a certain directory structure & contains a bunch of Krew plugin manifests.</p>
<blockquote>
<p>A <a href=https://krew.sigs.k8s.io/docs/developer-guide/plugin-manifest/>Krew plugin manifest</a> is a YAML file that describes the plugin, how it can be downloaded, and how it is installed on a machine.</p>
</blockquote>
<p>You can refer to the Krew docs on <a href=https://krew.sigs.k8s.io/docs/developer-guide/custom-indexes/>&ldquo;Hosting Custom Plugin Indexes&rdquo;</a> for details on how to host one.</p>
<h2 id=obtaining-a-github-personal-access-token>Obtaining a GitHub Personal Access Token</h2>
<p>In order for GoReleaser to push changes to your custom plugin index via the GitHub API, we need to prepare a Personal Access Token (PAT) with <code>repo</code> permissions.</p>
<p>You can refer to the GitHub docs on <a href=https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token>&ldquo;Creating a personal access token&rdquo;</a> on how to do this.</p>
<p>To be honest, I&rsquo;m not too thrilled with doing this with PATs as it grants GoReleaser access to all my repos when all I need is to only grant it commit access to the <a href=https://github.com/tohjustin/kubectl-plugins>tohjustin/kubectl-plugins</a> repository. At least based on the <a href=https://github.com/goreleaser/goreleaser/issues/2027#issuecomment-778330276>project owner&rsquo;s response in this GitHub issue</a>, it seems like he is open to looking into using <a href=https://docs.github.com/en/developers/overview/managing-deploy-keys#deploy-keys>deploy keys</a> to address this issue for GoReleaser v2. ðŸ˜…</p>
<h2 id=converting-a-krew-plugin-manifest-to-goreleaser-configuration>Converting a Krew plugin manifest to GoReleaser configuration</h2>
<p>Since pretty much all folks who has published a kubectl plugin to the official Krew index are familiar with what a Krew plugin manifest is, instead of writing a GoReleaser configuration from scratch, I thought it would be more interesting to do this backwards by converting an existing manifest into a GoReleaser configuration.</p>
<p>Here&rsquo;s an example of how a manifest looks like:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#75715e># https://github.com/kubernetes-sigs/krew-index/blob/master/plugins/lineage.yaml</span>
<span style=color:#f92672>apiVersion</span>: <span style=color:#e6db74>&#34;krew.googlecontainertools.github.com/v1alpha2&#34;</span>
<span style=color:#f92672>kind</span>: <span style=color:#e6db74>&#34;Plugin&#34;</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;lineage&#34;</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>version</span>: <span style=color:#e6db74>&#34;v0.4.2&#34;</span>
  <span style=color:#f92672>homepage</span>: <span style=color:#e6db74>&#34;https://github.com/tohjustin/kube-lineage&#34;</span>
  <span style=color:#f92672>shortDescription</span>: <span style=color:#e6db74>&#34;Display all dependent resources or resource dependencies&#34;</span>
  <span style=color:#f92672>description</span>: |<span style=color:#e6db74>
</span><span style=color:#e6db74>    This plugin prints a table of dependencies or dependents of the specified
</span><span style=color:#e6db74>    resource.</span>    
  <span style=color:#f92672>caveats</span>: |<span style=color:#e6db74>
</span><span style=color:#e6db74>    The tool only shows dependencies or dependents among the resources you have
</span><span style=color:#e6db74>    access to. So for restricted users, the result may be incomplete.</span>    
  <span style=color:#f92672>platforms</span>:
  - <span style=color:#f92672>selector</span>:
      <span style=color:#f92672>matchLabels</span>:
        <span style=color:#f92672>os</span>: <span style=color:#e6db74>&#34;darwin&#34;</span>
        <span style=color:#f92672>arch</span>: <span style=color:#e6db74>&#34;amd64&#34;</span>
    <span style=color:#f92672>uri</span>: <span style=color:#e6db74>&#34;https://github.com/tohjustin/kube-lineage/releases/download/v0.4.2/kube-lineage_darwin_amd64.tar.gz&#34;</span>
    <span style=color:#f92672>sha256</span>: <span style=color:#e6db74>&#34;75dd85e8f91a84e37a0e36f00697e6cadb864143b825f808ff540a2b93a2612b&#34;</span>
    <span style=color:#f92672>bin</span>: <span style=color:#e6db74>&#34;kube-lineage&#34;</span>
<span style=color:#75715e># ...</span>
</code></pre></div><p>First we use this manifest template to show which values we need to copy over to the GoReleaser config (values to copy over are replaced with template variables with names prefixed with <code>$</code>):</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>apiVersion</span>: <span style=color:#e6db74>&#34;krew.googlecontainertools.github.com/v1alpha2&#34;</span>
<span style=color:#f92672>kind</span>: <span style=color:#e6db74>&#34;Plugin&#34;</span>
<span style=color:#f92672>metadata</span>:
  <span style=color:#f92672>name</span>: <span style=color:#ae81ff>$PLUGIN_NAME</span>
<span style=color:#f92672>spec</span>:
  <span style=color:#f92672>homepage</span>: <span style=color:#ae81ff>$HOME_PAGE</span>
  <span style=color:#f92672>shortDescription</span>: <span style=color:#ae81ff>$SHORT_DESCRIPTION</span>
  <span style=color:#f92672>description</span>: <span style=color:#ae81ff>$DESCRIPTION</span>
  <span style=color:#f92672>caveats</span>: <span style=color:#ae81ff>$CAVEATS</span>
  <span style=color:#f92672>platforms</span>:
  - <span style=color:#f92672>selector</span>:
      <span style=color:#f92672>matchLabels</span>:
        <span style=color:#f92672>os</span>: <span style=color:#e6db74>&#34;darwin&#34;</span>
        <span style=color:#f92672>arch</span>: <span style=color:#e6db74>&#34;amd64&#34;</span>
    <span style=color:#f92672>uri</span>: <span style=color:#ae81ff>https://github.com/$KREW_INDEX_OWNER/$KREW_INDEX_REPO_NAME/releases/download/v0.4.2/kube-lineage_darwin_amd64.tar.gz</span>
    <span style=color:#f92672>sha256</span>: <span style=color:#e6db74>&#34;75dd85e8f91a84e37a0e36f00697e6cadb864143b825f808ff540a2b93a2612b&#34;</span>
    <span style=color:#f92672>bin</span>: <span style=color:#e6db74>&#34;kube-lineage&#34;</span>
<span style=color:#75715e># ...</span>
</code></pre></div><p>Then use this GoReleaser configuration template & its template variables to show where each value from the original manifest we should copy to:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#75715e># .goreleaser.yaml</span>
<span style=color:#f92672>krews</span>:
  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>$PLUGIN_NAME</span>
    <span style=color:#f92672>index</span>:
      <span style=color:#f92672>owner</span>: <span style=color:#ae81ff>$KREW_INDEX_OWNER</span>
      <span style=color:#f92672>name</span>: <span style=color:#ae81ff>$KREW_INDEX_REPO_NAME</span>
      <span style=color:#f92672>token</span>: <span style=color:#e6db74>&#34;{{ .Env.KREW_GITHUB_TOKEN }}&#34;</span>
    <span style=color:#f92672>url_template</span>: <span style=color:#ae81ff>https://github.com/$KREW_INDEX_OWNER/$KREW_INDEX_REPO_NAME/releases/download/{{ .Tag }}/{{ .ArtifactName }}</span>
    <span style=color:#f92672>commit_msg_template</span>: <span style=color:#e6db74>&#34;Krew plugin update for {{ .ProjectName }} version {{ .Tag }}&#34;</span>
    <span style=color:#f92672>homepage</span>: <span style=color:#ae81ff>$HOME_PAGE</span>
    <span style=color:#f92672>short_description</span>: <span style=color:#ae81ff>$SHORT_DESCRIPTION</span>
    <span style=color:#f92672>description</span>: <span style=color:#ae81ff>$DESCRIPTION</span>
    <span style=color:#f92672>caveats</span>: <span style=color:#ae81ff>$CAVEATS</span>
<span style=color:#75715e># ...</span>
</code></pre></div><p>Here&rsquo;s what the end result would look like:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#75715e># https://github.com/tohjustin/kube-lineage/blob/v0.4.2/.goreleaser.yaml#L54-L70</span>
<span style=color:#75715e># ...</span>
<span style=color:#f92672>krews</span>:
  - <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;lineage&#34;</span>
    <span style=color:#f92672>index</span>:
      <span style=color:#f92672>owner</span>: <span style=color:#e6db74>&#34;tohjustin&#34;</span>
      <span style=color:#f92672>name</span>: <span style=color:#e6db74>&#34;kubectl-plugins&#34;</span>
      <span style=color:#f92672>token</span>: <span style=color:#e6db74>&#34;{{ .Env.KREW_GITHUB_TOKEN }}&#34;</span>
    <span style=color:#f92672>url_template</span>: <span style=color:#e6db74>&#34;https://github.com/tohjustin/kube-lineage/releases/download/{{ .Tag }}/{{ .ArtifactName }}&#34;</span>
    <span style=color:#f92672>commit_msg_template</span>: <span style=color:#e6db74>&#34;Krew plugin update for {{ .ProjectName }} version {{ .Tag }}&#34;</span>
    <span style=color:#f92672>homepage</span>: <span style=color:#e6db74>&#34;https://github.com/tohjustin/kube-lineage&#34;</span>
    <span style=color:#f92672>short_description</span>: <span style=color:#e6db74>&#34;Display all dependent resources or resource dependencies&#34;</span>
    <span style=color:#f92672>description</span>: |<span style=color:#e6db74>
</span><span style=color:#e6db74>      This plugin prints a table of dependencies or dependents of the specified
</span><span style=color:#e6db74>      resource.</span>      
    <span style=color:#f92672>caveats</span>: |<span style=color:#e6db74>
</span><span style=color:#e6db74>      The tool only shows dependencies or dependents among the resources you have
</span><span style=color:#e6db74>      access to. So for restricted users, the result may be incomplete.</span>      
</code></pre></div><p>There&rsquo;s a lot other available options that you can configure for this Krew integration, you can refer to the <a href=https://goreleaser.com/customization/krew/>official GoReleaser docs</a> to find out more about them! ðŸ™‚</p>
<h2 id=configuring-github-actions-workflow>Configuring GitHub Actions workflow</h2>
<p>Since we will be running GoReleaser via a GitHub Actions workflow, we need to add the PAT obtained in the <a href=/posts/2021-11-16-goreleaser-krew-integration/#obtaining-a-github-personal-access-token>earlier step</a> as a secret in our repository. We can do it on GitHub via the repository&rsquo;s <strong>Settings</strong> page under the <strong>Secrets</strong> section:</p>
<p><img src=/images/2021-11-15-repository-secret.png alt=setting-repository-secret-on-github></p>
<p>You can see that I&rsquo;ve set the token as a secret named <code>KREW_GITHUB_TOKEN</code> which was referenced this in our <a href=https://github.com/tohjustin/kube-lineage/blob/v0.4.2/.goreleaser.yaml#L54-L70>GoReleaser configuration</a> earlier on.</p>
<p>Next we need to make sure we update our <a href=https://github.com/tohjustin/kube-lineage/blob/v0.4.2/.github/workflows/release.yaml#L66-L70>GitHub Actions workflow definition</a> to set the <code>KREW_GITHUB_TOKEN</code> environment variable so that GoReleaser can access it:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#75715e># https://github.com/tohjustin/kube-lineage/blob/v0.4.2/.github/workflows/release.yaml#L66-L70</span>
<span style=color:#75715e># ...</span>
      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Release</span>
        <span style=color:#f92672>run</span>: <span style=color:#ae81ff>make release</span>
        <span style=color:#f92672>env</span>:
          <span style=color:#f92672>GITHUB_TOKEN</span>: <span style=color:#ae81ff>${{ secrets.GITHUB_TOKEN }}</span>
          <span style=color:#f92672>KREW_GITHUB_TOKEN</span>: <span style=color:#ae81ff>${{ secrets.KREW_GITHUB_TOKEN }}</span>
<span style=color:#75715e># ...</span>
</code></pre></div><p>Finally we can run GoReleaser to publish our Krew plugin manifest!</p>
<p>Here&rsquo;s an example of the Git commit that GoReleaser has created on my custom plugin index hosted on GitHub at <a href=https://github.com/tohjustin/kubectl-plugins>tohjustin/kubectl-plugins</a>:</p>
<p><img src=/images/2021-11-15-goreleaser-commit.png alt=git-commit-created-by-goreleaser></p>
</div>
<div class=post-tags>
<nav class="nav tags">
<ul class=flat>
<li><a href=/tags/goreleaser>goreleaser</a></li>
<li><a href=/tags/kubectl-plugin>kubectl-plugin</a></li>
<li><a href=/tags/kubernetes>kubernetes</a></li>
</ul>
</nav>
</div>
</div>
<div class="footer wrapper">
<nav class=nav>
<div> Built with <a href=https://gohugo.io>Hugo</a></div>
</nav>
</div>
<script>feather.replace()</script>
</body>
</html>